# You can put sdcard on dir300 and dir600 both rev b1 (same board, name change to firmware)

# Using https://docs.google.com/document/d/1X3RId3d9MDHeSq82_6cZ_VaBjYVX7T0hU396oFHsEdA/edit?pref=2&pli=1#

### Prepare required stuff

apt-get install subversion build-essential libncurses5-dev zlib1g-dev gawk flex quilt git-core mkisofs openssl*
svn co svn://svn.openwrt.org/openwrt/branches/chaos_calmer
git clone https://github.com/Dirry/dir300b1-sdmod-extroot.git
git clone https://github.com/iugamarian/openwrtsetup

### Setting up OpenWRT
cd chaos_calmer
./scripts/feeds update -a
./scripts/feeds uninstall kmod-gpio-button-hotplug
./scripts/feeds uninstall kmod-input-gpio-keys-polled
./scripts/feeds uninstall kmod-leds-gpio
./scripts/feeds install -a -p kmod-fs-ext4
./scripts/feeds install -a -p kmod-mmc-over-gpio
make defconfig
make menuconfig

# Configure menuconfig with enter to go in, y for add, n for remove, esc - esc for back, esc...esc - enter to save file:
# Do not use SPACE bar

Target System: Ralink RT288x/RT3xxx
Subtarget: RT3x5x/RT5350 based boards


    Enable:
        Kernel Modules -> Filesystem -> kmod-fs-ext4
        Kernel Modules -> Other modules -> kmod-mmc-over-gpio
        Kernel Modules -> Other modules -> kmod-mmc-over-gpio -> Configuration
DI = 9
DO = 13
CLK = 8
CS = 0
SPI Support -> kmod-mmc-spi
    Disable:
        Base system -> block-mount (yes, you will must install block-mount later)
        Kernel Modules -> USB Support -> ALL, first the one down
        Kernel Modules -> LED Modules -> kmod-leds-gpio
        Kernel Modules -> Other modules -> kmod-gpio-button-hotplug

# Configure after ls /dev/mmc* gives results and dmesg | grep "DIRRY" gives results in OpenWrt
# I use 3300 ohm resistors for sdcard pins signaled with x:  ||x|g|x|v|g|x|x|/
# x = data or clock or select pins
# g = ground
# v = 3.3 V
# Between g and v added capacitor 1000 uF 6.3 V as without it high risk of crash, reboot

### Update gpiommc.c with DIRRY HACK patch
# done with: diff -Naur ./original/gpiommc.c ./modified/gpiommc.c > 865-gpiommc_dirry_hack.patch
# and then modified --- and +++ first two lines as in this patch:
# ./chaos_calmer/target/linux/generic/patches-3.18/864-gpiommc_configfs_locking.patch

cp openwrtsetup/865-gpiommc_dirry_hack.patch ./chaos_calmer/target/linux/generic/patches-3.18/

### Compile:

cd chaos_calmer
make prereq
make -j3

### Format the card on a pc as root (can have problems on router with formatting)

swapoff /dev/sdc
umount /dev/sdc
umount /mnt
dd if=/dev/zero of=/dev/sdc bs=1M count=16
mke2fs -t ext4 -m 0 -F -L EXTROOT -E lazy_itable_init=0,lazy_journal_init=0 /dev/sdc
mount /dev/sdc /mnt
mkdir -p /mnt/upper/overlay-boot
dd if=/dev/zero of=/mnt/upper/swapfile bs=1M count=64
mkswap /mnt/upper/swapfile
sync
sleep 2
umount /mnt

OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO

ssh root@192.168.1.1

OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO
mount -t ext4 /dev/mmcblk0 /mnt
tar -C /overlay -cvf - . | tar -C /mnt -xf -
# Boot fstab
block detect > /etc/config/fstab
sed -i 's/\/mnt\/mmcblk0/\/overlay/g' /etc/config/fstab
# Extroot fstab
cat <<EOF >> /mnt/upper/etc/config/fstab

config 'swap'
   option  device  '/swapfile'
   option  enabled '1'

config 'mount'
   option  target  /overlay-boot
   option  device  /dev/mtdblock6
   option  fstype  jffs2
   option  options  rw,sync
   option  enabled  '1'
   option  enabled_fsck  0
EOF
cat <<EOF >> /mnt/upper/etc/sysctl.conf
vm.swappiness = 60
vm.min_free_kbytes = 2048
vm.vfs_cache_pressure = 500
vm.dirty_bytes = 2097152
vm.dirty_background_bytes = 2097152
vm.dirty_writeback_centisecs = 600
vm.dirty_expire_centisecs = 600
EOF
cat <<EOF >> /mnt/upper/etc/modules-boot.d/mmc
gpiommc
mmc_spi
EOF
cat <<EOF > /mnt/upper/etc/opkg.conf
dest root /
dest ram /tmp
lists_dir ext /var/opkg-lists
option overlay_root /overlay
src/gz chaos_calmer_base http://downloads.openwrt.org/chaos_calmer/15.05/ar71xx/generic/packages/base
src/gz chaos_calmer_luci http://downloads.openwrt.org/chaos_calmer/15.05/ar71xx/generic/packages/luci
src/gz chaos_calmer_packages http://downloads.openwrt.org/chaos_calmer/15.05/ar71xx/generic/packages/packages
src/gz chaos_calmer_routing http://downloads.openwrt.org/chaos_calmer/15.05/ar71xx/generic/packages/routing
src/gz chaos_calmer_telephony http://downloads.openwrt.org/chaos_calmer/15.05/ar71xx/generic/packages/telephony
src/gz chaos_calmer_management http://downloads.openwrt.org/chaos_calmer/15.05/ar71xx/generic/packages/management
option check_signature 1
option force_space
EOF
sync
umount /mnt
vi /etc/config/fstab

# sed command with \x20 and \x27 does not work - make all enabled '0' be enabled '1'
# press i, modify, press esc, write ":wq!" enter
# to restore back, can put enabled '0' at /overlay in /overlay-boot/etc/config/fstab

